<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Library</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="library-container">
            <!-- Header with user info and logout -->
            <div class="library-header">
                <h1>Chat Groups</h1>
                <div class="user-info">
                    <span id="displayUsername">User</span>
                    <button onclick="logout()" class="btn-logout">Logout</button>
                </div>
            </div>

            <!-- Form to create new chat group -->
            <div class="create-group">
                <h2>Create New Group</h2>
                <form id="createGroupForm">
                    <div class="form-group-inline">
                        <input type="text" id="groupName" placeholder="Enter group name" required>
                        <button type="submit" class="btn-primary">Create</button>
                    </div>
                    <p class="error-msg" id="createError"></p>
                </form>
            </div>

            <!-- List of all chat groups -->
            <div class="groups-section">
                <h2>Available Groups</h2>
                <div id="groupsList" class="groups-list">
                    <p class="loading">Loading groups...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK v10 -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, query, onSnapshot, orderBy, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration (same as login page)
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

// Check if user is authenticated - FIXED VERSION
onAuthStateChanged(auth, (user) => {
    if (!user) {
        // No user signed in, redirect to login
        window.location.href = 'index.html';
    } else {
        // Get username from multiple sources (priority order)
        let username = localStorage.getItem('chatAppUsername');
        
        // If not in localStorage, try to get from Firebase user
        if (!username || username === 'null' || username === 'Anonymous') {
            username = user.displayName;
        }
        
        // If still no username, use email prefix
        if (!username || username === 'null') {
            username = user.email ? user.email.split('@')[0] : 'User';
        }
        
        // Update localStorage with the found username
        localStorage.setItem('chatAppUsername', username);
        
        // Display username
        document.getElementById('displayUsername').textContent = username;
        
        // Load chat groups
        loadChatGroups();
    }
});


        // Logout function
        window.logout = async function() {
            try {
                await signOut(auth);
                localStorage.removeItem('chatAppUsername');
                localStorage.removeItem('chatAppUserId');
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        // Create new chat group
        document.getElementById('createGroupForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const groupName = document.getElementById('groupName').value.trim();
            const errorMsg = document.getElementById('createError');
            const username = localStorage.getItem('chatAppUsername');

            try {
                // Add new group to Firestore 'groups' collection
                await addDoc(collection(db, 'groups'), {
                    name: groupName,
                    createdBy: username,
                    createdAt: serverTimestamp() // Server timestamp for accuracy
                });

                // Clear input field
                document.getElementById('groupName').value = '';
                errorMsg.textContent = '';
                
            } catch (error) {
                errorMsg.textContent = 'Failed to create group. Try again.';
                console.error('Error creating group:', error);
            }
        });

        // Load and listen to chat groups in real-time
        function loadChatGroups() {
            const groupsList = document.getElementById('groupsList');
            
            // Create a query to get groups ordered by creation time
            const q = query(collection(db, 'groups'), orderBy('createdAt', 'desc'));

            // Listen to real-time updates using onSnapshot
            onSnapshot(q, (snapshot) => {
                groupsList.innerHTML = ''; // Clear existing list

                if (snapshot.empty) {
                    groupsList.innerHTML = '<p class="no-groups">No groups yet. Create one!</p>';
                    return;
                }

                // Loop through each group document
                snapshot.forEach((doc) => {
                    const group = doc.data();
                    
                    // Create group card element
                    const groupCard = document.createElement('div');
                    groupCard.className = 'group-card';
                    groupCard.innerHTML = `
                        <h3>${group.name}</h3>

                    `;
                    
                    // Add click event to open chat room
                    groupCard.addEventListener('click', () => {
                        // Navigate to chat room with group ID
                        window.location.href = `chat-room.html?groupId=${doc.id}&groupName=${encodeURIComponent(group.name)}`;
                    });

                    groupsList.appendChild(groupCard);
                });
            }, (error) => {
                console.error('Error loading groups:', error);
                groupsList.innerHTML = '<p class="error-msg">Failed to load groups.</p>';
            });
        }
    </script>
</body>
</html>
